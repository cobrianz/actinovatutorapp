import OpenAI from 'openai';
import { NextResponse } from "next/server";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export async function POST(request) {
  try {
    const { lessonTitle, moduleTitle, courseTitle, courseTopic, difficulty } = await request.json();

    if (!lessonTitle || !courseTitle) {
      return NextResponse.json(
        { error: 'Missing required parameters' },
        { status: 400 }
      );
    }

    const prompt = `Generate detailed lesson content for:

Course: ${courseTitle}
Module: ${moduleTitle || 'N/A'}
Lesson: ${lessonTitle}
Level: ${difficulty || 'intermediate'}

Create comprehensive content (800-1200 words) using proper Markdown:

FORMATTING:
- **bold** for key terms (double asterisks)
- *italics* for emphasis (single asterisks)
- \`code\` for inline code
- \`\`\`language for code blocks
- ## for headers, ### for subheaders
- $math$ for inline equations
- > for important notes
- - for bullet lists

STRUCTURE:
- Introduction
- 3-5 main concepts with examples
- Practical code examples in code blocks
- Real-world applications
- Practice exercises

Make it educational and well-formatted.`;

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: "You are an expert educator. Create detailed lesson content with proper Markdown formatting. Use **bold**, *italics*, ```code blocks```, and clear headers. Be comprehensive and engaging."
        },
        {
          role: "user",
          content: prompt
        }
      ],
      temperature: 0.7,
      max_tokens: 4000,
    });

    return NextResponse.json({
      success: true,
      content: completion.choices[0].message.content
    });

  } catch (error) {
    console.error('Error generating lesson:', error);
    return NextResponse.json(
      { error: 'Failed to generate lesson content' },
      { status: 500 }
    );
  }
}
