# Actinova AI Tutor - Complete API Reference

**Version:** 1.0.0  
**Last Updated:** December 29, 2025  
**Base URL:** `https://actinova.ai/api` or [/api](file:///f:/Actinova/Actinova-ai-tutor-app/src/app/api) (relative)

---

## Table of Contents

1. [API Overview](#api-overview)
2. [Authentication](#authentication)
3. [User ID Tracking & Multi-Tenancy](#user-id-tracking--multi-tenancy)
4. [Authentication APIs](#authentication-apis)
5. [User Management APIs](#user-management-apis)
6. [Content Generation APIs](#content-generation-apis)
7. [Course Management APIs](#course-management-apis)
8. [Flashcard APIs](#flashcard-apis)
9. [Quiz APIs](#quiz-apis)
10. [Billing & Subscription APIs](#billing--subscription-apis)
11. [Content Discovery APIs](#content-discovery-apis)
12. [Utility APIs](#utility-apis)
13. [Error Codes & Handling](#error-codes--handling)

---

## API Overview

### Architecture
- **Framework**: Next.js 16.1.0 API Routes (Serverless Functions)
- **Authentication**: JWT tokens (HTTP-only cookies + Bearer tokens)
- **Database**: MongoDB with Mongoose ODM
- **Rate Limiting**: IP-based with in-memory storage
- **CORS**: Enabled with middleware wrapper

### Common Headers

```http
Content-Type: application/json
Authorization: Bearer <jwt_token>
X-CSRF-Token: <csrf_token>  # Required for state-changing operations
```

### Response Format

All APIs return JSON with consistent structure:

**Success Response**:
```json
{
  "success": true,
  "data": {...},
  "message": "Optional success message"
}
```

**Error Response**:
```json
{
  "success": false,
  "error": "Error message",
  "details": "Additional error details (dev only)"
}
```

---

## Authentication

### Token Types

1. **Access Token (JWT)**
   - Lifetime: 24 hours
   - Storage: HTTP-only cookie + localStorage (Capacitor)
   - Contains: `{ id, email, role, iat, exp }`

2. **Refresh Token**
   - Lifetime: 30 days
   - Storage: Database `users.refreshTokens[]`
   - Auto-cleanup: Expired tokens removed on use

3. **CSRF Token**
   - Generated per session
   - Required for: POST, PUT, DELETE, PATCH
   - Validated server-side

### Authentication Flow

```mermaid
sequenceDiagram
    participant C as Client
    participant A as API
    participant DB as Database
    
    C->>A: POST /api/auth/login {email, password}
    A->>DB: Find user by email
    DB-->>A: User document
    A->>A: Verify password (bcrypt)
    A->>A: Generate JWT token
    A->>A: Set HTTP-only cookie
    A-->>C: {success, user, token}
    C->>C: Store token (if Capacitor)
    
    Note over C,A: Subsequent Requests
    C->>A: GET /api/me (with cookie/header)
    A->>A: Verify JWT
    A->>DB: Fetch user data
    DB-->>A: User document
    A-->>C: {success, user}
```

---

## User ID Tracking & Multi-Tenancy

### Implementation

**All content-creating APIs track userId** to ensure proper data isolation and ownership:

```javascript
// Standard pattern across all APIs
const userId = decoded.id;  // From JWT token
const user = await db.collection("users").findOne({ 
  _id: new ObjectId(userId) 
});

// When creating content
const course = {
  _id: new ObjectId(),
  userId: new ObjectId(userId),  // Owner tracking
  createdBy: new ObjectId(userId),  // Creator tracking
  title: "Course Title",
  // ... other fields
};
```

### Multi-Tenancy Benefits

1. **Data Isolation**: Users only see their own content
2. **Usage Tracking**: Per-user limits and analytics
3. **Billing**: Subscription tied to userId
4. **Security**: Prevents unauthorized access
5. **Cleanup**: Easy deletion of user data (GDPR compliance)

### APIs with userId Tracking

✅ **All 59 endpoints** properly track userId where applicable:
- Content generation (courses, flashcards, quizzes)
- Content management (CRUD operations)
- Progress tracking
- Billing history
- User preferences

---

## Authentication APIs

### POST /api/auth/signup

**Purpose**: Create a new user account with email verification.

**Business Logic**:
1. Validate input (email format, password strength, terms acceptance)
2. Check for existing email (prevent duplicates)
3. Hash password using bcrypt (12 rounds)
4. Generate 6-digit verification code
5. Create user with `status: "pending"`
6. Send verification email (async, non-blocking)
7. Return success response

**Request**:
```json
{
  "firstName": "John",
  "lastName": "Doe",
  "email": "john@example.com",
  "password": "SecureP@ss123",
  "confirmPassword": "SecureP@ss123",
  "acceptTerms": true
}
```

**Password Requirements**:
- Minimum 8 characters
- At least one uppercase letter (A-Z)
- At least one lowercase letter (a-z)
- At least one number (0-9)
- At least one special character (any non-alphanumeric)

**Validation**:
```javascript
// Server-side validation
if (!/[a-z]/.test(password)) errors.push("lowercase letter");
if (!/[A-Z]/.test(password)) errors.push("uppercase letter");
if (!/\d/.test(password)) errors.push("number");
if (!/[^a-zA-Z0-9]/.test(password)) errors.push("special character");
```

**Response** (201 Created):
```json
{
  "success": true,
  "message": "Account created successfully! Please check your email to verify your account.",
  "requiresVerification": true,
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "name": "John Doe",
    "email": "john@example.com",
    "isPremium": false,
    "usage": {
      "used": 0,
      "limit": 5,
      "remaining": 5,
      "percentage": 0,
      "isPremium": false
    }
  }
}
```

**Rate Limiting**: 5 attempts per 15 minutes per IP

**Error Responses**:
- `400`: Invalid input, weak password, passwords don't match
- `409`: Email already exists
- `429`: Too many signup attempts
- `500`: Server error

---

### POST /api/auth/login

**Purpose**: Authenticate user and create session.

**Business Logic**:
1. Find user by email (case-insensitive)
2. Check account status (active, locked, pending)
3. Verify password using bcrypt
4. Check email verification status
5. Reset login attempts on success
6. Generate JWT token
7. Set HTTP-only cookie
8. Update `lastLogin` timestamp

**Request**:
```json
{
  "email": "john@example.com",
  "password": "SecureP@ss123"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "email": "john@example.com",
    "name": "John Doe",
    "role": "student",
    "isPremium": true,
    "onboardingCompleted": true,
    "subscription": {
      "plan": "pro",
      "status": "active",
      "expiresAt": "2026-01-29T00:00:00.000Z"
    }
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

**Security Features**:
- Account lockout after 5 failed attempts (2 hours)
- Password comparison using constant-time algorithm
- Secure cookie with `httpOnly`, `secure`, `sameSite` flags

**Error Responses**:
- `400`: Missing credentials
- `401`: Invalid credentials, email not verified
- `403`: Account locked or suspended
- `500`: Server error

---

### POST /api/auth/verify-email

**Purpose**: Verify user email with 6-digit code or token.

**Business Logic**:
1. Accept either `code` (6 digits) or `token` (UUID)
2. Find user with matching verification data
3. Check expiration (24 hours)
4. Update user status to "active"
5. Clear verification fields
6. Generate login token
7. Return authenticated session

**Request**:
```json
{
  "code": "123456"
}
// OR
{
  "token": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Email verified successfully",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "email": "john@example.com",
    "emailVerified": true,
    "status": "active"
  }
}
```

**Error Responses**:
- `400`: Invalid or expired code/token
- `404`: User not found
- `500`: Server error

---

### POST /api/auth/forgot-password

**Purpose**: Initiate password reset process.

**Business Logic**:
1. Find user by email
2. Generate 6-digit reset code
3. Set expiration (1 hour)
4. Send reset email with code
5. Return success (even if email doesn't exist - security)

**Request**:
```json
{
  "email": "john@example.com"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Password reset code sent to your email"
}
```

**Security**: Always returns success to prevent email enumeration

---

### POST /api/auth/reset-password

**Purpose**: Reset password using verification token.

**Business Logic**:
1. Validate token and expiration
2. Verify password strength
3. Check password confirmation match
4. Hash new password
5. Clear reset token
6. Update `lastPasswordChange`
7. Invalidate all refresh tokens (force re-login)

**Request**:
```json
{
  "token": "reset-token-uuid",
  "password": "NewP@ss123",
  "confirmPassword": "NewP@ss123"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Password reset successfully. Please log in."
}
```

---

## Content Generation APIs

### POST /api/generate-course

**Purpose**: Generate AI-powered course content with modules and lessons.

**Business Logic**:
1. **Authentication**: Extract userId from JWT token
2. **User Lookup**: Fetch user document to determine plan
3. **Plan Limits**: Check subscription tier (free/premium/enterprise)
4. **Duplicate Check**: Search for existing course with same topic/difficulty
5. **Usage Tracking**: Check monthly generation limit
6. **AI Generation**: Call OpenAI GPT-4 with structured prompt
7. **Content Parsing**: Parse JSON response, validate structure
8. **Database Storage**: Save course with userId reference
9. **Usage Update**: Increment monthly usage counter
10. **Response**: Return course data with limits info

**Plan Limits**:
| Plan | Modules | Lessons/Module | Total Lessons | Monthly Generations |
|------|---------|----------------|---------------|---------------------|
| Free | 3 | 3 | 9 | 3 |
| Premium | 20 | 5 | 100 | 50 |
| Enterprise | 30 | 8 | 240 | Unlimited |

**Request**:
```json
{
  "topic": "Introduction to Python Programming",
  "difficulty": "beginner",
  "modules": 5,
  "lessonsPerModule": 3
}
```

**Validation**:
```javascript
// Difficulty validation
if (!["beginner", "intermediate", "advanced"].includes(difficulty)) {
  return error("Invalid difficulty");
}

// Plan limit validation
const limits = getUserPlanLimits(user);
if (modules > limits.modules) {
  return error(`Maximum ${limits.modules} modules allowed`);
}
```

**AI Prompt Structure**:
```javascript
const prompt = `Generate a comprehensive course on "${topic}" at ${difficulty} level.

Structure:
- ${modules} modules
- ${lessonsPerModule} lessons per module
- Each lesson: 800-1200 words
- Include: explanations, examples, practice exercises
- Format: Markdown with headings, lists, code blocks

Return JSON:
{
  "title": "Course Title",
  "level": "${difficulty}",
  "totalModules": ${modules},
  "totalLessons": ${modules * lessonsPerModule},
  "modules": [
    {
      "id": 1,
      "title": "Module Title",
      "lessons": [
        {
          "title": "Lesson Title",
          "content": "Markdown content..."
        }
      ]
    }
  ]
}`;
```

**Response** (200 OK):
```json
{
  "success": true,
  "course": {
    "_id": "507f1f77bcf86cd799439011",
    "userId": "507f1f77bcf86cd799439011",
    "title": "Introduction to Python Programming",
    "level": "beginner",
    "totalModules": 5,
    "totalLessons": 15,
    "modules": [
      {
        "id": 1,
        "title": "Python Basics",
        "lessons": [
          {
            "title": "Variables and Data Types",
            "content": "# Variables and Data Types\n\n..."
          }
        ]
      }
    ],
    "createdAt": "2025-12-29T19:00:00.000Z"
  },
  "usage": {
    "used": 1,
    "limit": 3,
    "remaining": 2,
    "resetsOn": "2026-01-01"
  }
}
```

**Duplicate Handling**:
```javascript
// Check for existing course
const existing = await db.collection("courses").findOne({
  userId: new ObjectId(userId),
  title: { $regex: new RegExp(topic, 'i') },
  level: difficulty
});

if (existing) {
  return {
    success: true,
    course: existing,
    duplicate: true,
    message: "Returning existing course"
  };
}
```

**Error Responses**:
- `400`: Invalid topic or difficulty
- `401`: Not authenticated
- `403`: Plan limit exceeded
- `429`: Monthly generation limit reached
- `500`: AI generation failed

---

### POST /api/generate-flashcards

**Purpose**: Generate spaced-repetition flashcard sets.

**Business Logic**:
1. **Authentication & Plan Check**: Determine card limit (free: 8, premium: 40)
2. **Duplicate Detection**: Check for existing set with same topic/difficulty
3. **Monthly Limit**: Enforce generation limits (free: 2, premium: 20)
4. **AI Generation**: Generate cards with SM-2 algorithm data
5. **SRS Initialization**: Set initial intervals, ease factors
6. **Database Storage**: Save with userId reference
7. **Usage Tracking**: Increment monthly counter

**Request**:
```json
{
  "topic": "JavaScript ES6 Features",
  "difficulty": "intermediate",
  "numberOfCards": 20,
  "existingCardSetId": null,  // Optional: add to existing set
  "additionalCards": null     // Optional: number to add
}
```

**Card Structure**:
```json
{
  "id": 1,
  "question": "What is destructuring in ES6?",
  "answer": "A way to extract values from arrays or properties from objects into distinct variables",
  "explanation": "Destructuring allows you to unpack values...",
  "keyPoints": [
    "Works with arrays and objects",
    "Supports default values",
    "Can be used in function parameters"
  ],
  "example": "const {name, age} = person;",
  "category": "concept",
  "difficulty": "intermediate",
  "srs": {
    "interval": 1,
    "repetitions": 0,
    "ease": 2.5,
    "dueDate": "2025-12-29T19:00:00.000Z"
  }
}
```

**SM-2 Algorithm**:
```javascript
// Spaced Repetition System
function updateSRS(card, quality) {
  // quality: 0-5 (0=complete blackout, 5=perfect recall)
  if (quality >= 3) {
    if (card.srs.repetitions === 0) {
      card.srs.interval = 1;
    } else if (card.srs.repetitions === 1) {
      card.srs.interval = 6;
    } else {
      card.srs.interval = Math.round(card.srs.interval * card.srs.ease);
    }
    card.srs.repetitions++;
  } else {
    card.srs.repetitions = 0;
    card.srs.interval = 1;
  }
  
  card.srs.ease = card.srs.ease + (0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02));
  card.srs.ease = Math.max(1.3, card.srs.ease);
  card.srs.dueDate = new Date(Date.now() + card.srs.interval * 24 * 60 * 60 * 1000);
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "cardSetId": "507f1f77bcf86cd799439011",
  "title": "JavaScript ES6 Features - Intermediate",
  "totalCards": 20,
  "difficulty": "intermediate",
  "isPremium": true,
  "canExportToAnki": true,
  "monthly": {
    "used": 1,
    "limit": 20,
    "resetsOn": "2026-01-01"
  },
  "features": [
    "Spaced Repetition (SM-2)",
    "Review History",
    "Anki Export",
    "Shareable Link",
    "Bookmark & Progress",
    "Auto-reset Monthly Limits"
  ]
}
```

---

### POST /api/quizzes

**Purpose**: Generate assessment quizzes with multiple-choice questions.

**Business Logic**:
1. **User Authentication**: Verify JWT and fetch user
2. **Plan Validation**: Check quiz generation limits
3. **AI Generation**: Create questions with GPT-4
4. **Answer Validation**: Ensure correct answers are valid options
5. **Database Storage**: Save quiz with userId
6. **Response**: Return quiz data

**Request**:
```json
{
  "topic": "World History",
  "difficulty": "intermediate",
  "numberOfQuestions": 10
}
```

**Quiz Structure**:
```json
{
  "_id": "507f1f77bcf86cd799439011",
  "userId": "507f1f77bcf86cd799439011",
  "title": "World History Quiz",
  "topic": "World History",
  "difficulty": "intermediate",
  "questions": [
    {
      "text": "When did World War II end?",
      "options": ["1943", "1944", "1945", "1946"],
      "correctAnswer": "1945",
      "explanation": "World War II ended in 1945..."
    }
  ],
  "performances": [],
  "createdAt": "2025-12-29T19:00:00.000Z"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "quiz": {
    "_id": "507f1f77bcf86cd799439011",
    "title": "World History Quiz",
    "topic": "World History",
    "difficulty": "intermediate",
    "questions": [...],
    "totalQuestions": 10
  }
}
```

---

## User Management APIs

### GET /api/me

**Purpose**: Get current authenticated user's profile.

**Business Logic**:
1. Verify JWT token from cookie or header
2. Fetch user document from database
3. Calculate usage statistics
4. Return sanitized user data (no password)

**Response** (200 OK):
```json
{
  "success": true,
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "email": "john@example.com",
    "name": "John Doe",
    "role": "student",
    "isPremium": true,
    "emailVerified": true,
    "onboardingCompleted": true,
    "subscription": {
      "plan": "pro",
      "status": "active",
      "startedAt": "2025-01-01T00:00:00.000Z",
      "expiresAt": "2026-01-01T00:00:00.000Z",
      "autoRenew": true
    },
    "usage": {
      "used": 5,
      "limit": 50,
      "remaining": 45,
      "percentage": 10,
      "isPremium": true
    },
    "settings": {
      "theme": "dark",
      "notifications": {
        "email": true,
        "push": false
      }
    }
  }
}
```

---

### PUT /api/profile

**Purpose**: Update user profile information.

**Business Logic**:
1. Authenticate user
2. Validate input fields
3. Sanitize data (trim strings, validate formats)
4. Update allowed fields only
5. Return updated profile

**Request**:
```json
{
  "firstName": "John",
  "lastName": "Doe",
  "bio": "Software developer and lifelong learner",
  "interests": ["programming", "ai", "web development"],
  "skillLevel": "intermediate",
  "generatedPremiumCourses": [
    {
      "courseId": "507f1f77bcf86cd799439011",
      "courseTitle": "Advanced Python",
      "generatedAt": "2025-12-29T19:00:00.000Z"
    }
  ]
}
```

**Allowed Fields**:
- `firstName`, `lastName`
- `bio` (max 500 chars)
- `interests`, `interestCategories`
- `skillLevel`, `goals`, `timeCommitment`
- `ageGroup`, `educationLevel`, `learningStyle`
- `generatedPremiumCourses` (array)
- `onboardingCompleted` (boolean)

**Protected Fields** (cannot be updated via this endpoint):
- `email`, `password`
- `role`, `status`
- `subscription`, `billingHistory`
- `emailVerified`

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Profile updated successfully",
  "user": {
    "id": "507f1f77bcf86cd799439011",
    "firstName": "John",
    "lastName": "Doe",
    "bio": "Software developer and lifelong learner",
    "interests": ["programming", "ai", "web development"]
  }
}
```

---

## Billing & Subscription APIs

### POST /api/billing/create-session

**Purpose**: Initialize Paystack payment session.

**Business Logic**:
1. Authenticate user
2. Validate plan selection
3. Calculate amount based on plan and billing cycle
4. Create Paystack transaction
5. Return checkout URL

**Request**:
```json
{
  "plan": "pro",
  "billingCycle": "monthly",
  "paymentMethod": "card"
}
```

**Pricing**:
```javascript
const PLANS = {
  pro: {
    monthly: 999900,  // ₦9,999 in kobo
    yearly: 11158800  // ₦111,588 (7% discount)
  },
  enterprise: {
    monthly: 4999900,  // Custom pricing
    yearly: 55794000
  }
};
```

**Response** (200 OK):
```json
{
  "success": true,
  "sessionUrl": "https://checkout.paystack.com/abc123",
  "reference": "T123456789",
  "amount": 999900,
  "currency": "NGN",
  "plan": "pro",
  "billingCycle": "monthly"
}
```

---

### GET /api/billing/verify-payment

**Purpose**: Verify payment after Paystack redirect.

**Business Logic**:
1. Extract reference from query params
2. Verify transaction with Paystack API
3. Update user subscription
4. Record billing history
5. Send receipt email
6. Redirect to dashboard

**Query Parameters**:
- `reference`: Paystack transaction reference

**Flow**:
```mermaid
sequenceDiagram
    participant U as User
    participant P as Paystack
    participant A as API
    participant DB as Database
    
    U->>P: Complete payment
    P->>A: Redirect with reference
    A->>P: Verify transaction
    P-->>A: Transaction details
    A->>DB: Update subscription
    A->>DB: Save billing history
    A->>U: Send receipt email
    A-->>U: Redirect to dashboard
```

**Response**: HTTP 302 Redirect to `/dashboard?payment=success`

---

### POST /api/billing/webhook

**Purpose**: Handle Paystack webhook events.

**Events Handled**:
- `charge.success`: Payment successful
- `subscription.create`: Subscription created
- `subscription.disable`: Subscription cancelled
- `invoice.payment_failed`: Payment failed

**Security**:
```javascript
// Verify Paystack signature
const hash = crypto
  .createHmac('sha512', process.env.PAYSTACK_SECRET_KEY)
  .update(JSON.stringify(req.body))
  .digest('hex');

if (hash !== req.headers['x-paystack-signature']) {
  return res.status(400).send('Invalid signature');
}
```

**Business Logic** (charge.success):
1. Verify signature
2. Extract transaction data
3. Find user by email or reference
4. Update subscription status
5. Set expiration date
6. Save authorization for auto-renewal
7. Record billing history
8. Send confirmation email

**Webhook Payload**:
```json
{
  "event": "charge.success",
  "data": {
    "reference": "T123456789",
    "amount": 999900,
    "customer": {
      "email": "john@example.com",
      "customer_code": "CUS_abc123"
    },
    "authorization": {
      "authorization_code": "AUTH_abc123",
      "card_type": "visa",
      "last4": "4081",
      "exp_month": "12",
      "exp_year": "2026"
    },
    "paid_at": "2025-12-29T19:00:00.000Z"
  }
}
```

---

## Error Codes & Handling

### HTTP Status Codes

| Code | Meaning | Usage |
|------|---------|-------|
| 200 | OK | Successful GET, PUT, DELETE |
| 201 | Created | Successful POST (resource created) |
| 400 | Bad Request | Invalid input, validation error |
| 401 | Unauthorized | Missing or invalid token |
| 403 | Forbidden | Insufficient permissions, plan limit |
| 404 | Not Found | Resource doesn't exist |
| 409 | Conflict | Duplicate entry (email, etc.) |
| 429 | Too Many Requests | Rate limit exceeded |
| 500 | Server Error | Internal error, AI failure |

### Error Response Format

```json
{
  "success": false,
  "error": "User-friendly error message",
  "details": "Technical details (dev only)",
  "code": "ERROR_CODE",
  "field": "fieldName"  // For validation errors
}
```

### Common Error Scenarios

**Authentication Errors**:
```json
{
  "success": false,
  "error": "Invalid or expired token",
  "code": "AUTH_INVALID_TOKEN"
}
```

**Validation Errors**:
```json
{
  "success": false,
  "error": "Validation failed",
  "details": {
    "email": "Invalid email format",
    "password": "Password too weak"
  },
  "code": "VALIDATION_ERROR"
}
```

**Rate Limit Errors**:
```json
{
  "success": false,
  "error": "Too many requests. Please try again later.",
  "retryAfter": 900,  // seconds
  "code": "RATE_LIMIT_EXCEEDED"
}
```

**Plan Limit Errors**:
```json
{
  "success": false,
  "error": "Monthly generation limit reached",
  "used": 3,
  "limit": 3,
  "resetsOn": "2026-01-01",
  "upgrade": true,
  "code": "PLAN_LIMIT_EXCEEDED"
}
```

---

## API Security Best Practices

### 1. Input Validation
```javascript
// Validate all inputs
const schema = z.object({
  email: z.string().email(),
  password: z.string().min(8),
  firstName: z.string().min(2).max(50)
});

const result = schema.safeParse(body);
if (!result.success) {
  return error(result.error);
}
```

### 2. SQL Injection Prevention
```javascript
// Use Mongoose/MongoDB ObjectId
const userId = new ObjectId(req.params.id);  // Validates format
const user = await db.collection("users").findOne({ _id: userId });
```

### 3. XSS Prevention
```javascript
// React automatically escapes
<div>{userInput}</div>  // Safe

// Manual sanitization if needed
import DOMPurify from 'dompurify';
const clean = DOMPurify.sanitize(dirty);
```

### 4. CSRF Protection
```javascript
// Verify CSRF token on state-changing requests
const csrfToken = req.headers['x-csrf-token'];
if (!verifyCsrfToken(csrfToken, session)) {
  return error("Invalid CSRF token", 403);
}
```

### 5. Rate Limiting
```javascript
const attempts = new Map();
const RATE_LIMIT = { max: 5, windowMs: 15 * 60 * 1000 };

function checkRateLimit(ip) {
  const record = attempts.get(ip) || { count: 0, resetAt: Date.now() };
  if (Date.now() - record.resetAt > RATE_LIMIT.windowMs) {
    record.count = 1;
    record.resetAt = Date.now();
  } else if (record.count >= RATE_LIMIT.max) {
    throw new Error("Rate limit exceeded");
  }
  record.count++;
  attempts.set(ip, record);
}
```

---

## Appendix: Complete API List

### Authentication (11 endpoints)
- `POST /api/auth/signup`
- `POST /api/auth/login`
- `POST /api/auth/logout`
- `POST /api/auth/refresh`
- `POST /api/auth/verify-email`
- `POST /api/auth/resend-verification`
- `POST /api/auth/forgot-password`
- `POST /api/auth/verify-reset-code`
- `POST /api/auth/validate-reset-token`
- `POST /api/auth/reset-password`
- `POST /api/auth/welcome-email`

### User Management (4 endpoints)
- `GET /api/me`
- `GET /api/profile`
- `PUT /api/profile`
- `DELETE /api/profile`
- `POST /api/change-password`

### Content Generation (4 endpoints)
- `POST /api/generate-course`
- `POST /api/generate-flashcards`
- `POST /api/generate-image`
- `POST /api/chat`

### Courses (5 endpoints)
- `GET /api/courses`
- `GET /api/courses/[id]`
- `POST /api/courses`
- `DELETE /api/courses/delete`
- `GET /api/course-download`

### Flashcards (3 endpoints)
- `GET /api/flashcards`
- `GET /api/flashcards/[id]`
- `POST /api/flashcards`

### Quizzes (4 endpoints)
- `GET /api/quizzes`
- `GET /api/quizzes/[id]`
- `POST /api/quizzes`
- `POST /api/quizzes/[id]/performance`

### Billing (4 endpoints)
- `POST /api/billing/create-session`
- `GET /api/billing/verify-payment`
- `POST /api/billing/webhook`
- `GET /api/billing/test-paystack`

### Discovery (5 endpoints)
- `GET /api/explore`
- `GET /api/premium-courses`
- `GET /api/premium-courses/trending`
- `GET /api/premium-courses/personalized`
- `POST /api/premium-courses/favorites`

### Utility (19 endpoints)
- `GET /api/library`
- `POST /api/bookmarks`
- `GET /api/notes`
- `GET /api/plans`
- `GET /api/popular-topics`
- `POST /api/contact`
- `GET /api/visitors`
- `POST /api/session/start`
- `POST /api/session/end`
- `GET /api/chat/history`
- `POST /api/course-agent`
- `GET /api/course-progress`
- `GET /api/guides`
- `GET /api/guides/[id]`
- `GET /api/posts`
- `GET /api/posts/[id]`
- `POST /api/posts/[id]/comments`
- `POST /api/posts/[id]/like`
- `PUT /api/settings/update`

**Total**: 59 API endpoints

---

**Document End**

*For API updates and support, contact: api-support@actinova.ai*
