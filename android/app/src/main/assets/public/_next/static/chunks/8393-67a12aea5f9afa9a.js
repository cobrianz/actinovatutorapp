"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8393],{5669:(e,r,t)=>{t.d(r,{Ud:()=>i,e9:()=>n});var a=t(41463);let s=window.origin?.startsWith("capacitor://")||window.origin?.startsWith("http://localhost")||window.origin?.startsWith("https://localhost")||"capacitor:"===window.location.protocol||!!window.Capacitor;console.log("[Actinova] Environment:",{origin:window.origin,isCapacitor:s,protocol:window.location.protocol});let o=a.env.NEXT_PUBLIC_API_URL||"https://actinovatutorapp.vercel.app";function n(e){if(!e)return o;if(e.startsWith("http://")||e.startsWith("https://"))return e;let r=e.startsWith("/")?e:`/${e}`;return s?`${o}${r}`:r}async function i(e,r={}){let t=n(e),a={"Content-Type":"application/json",...r.headers};if(s){let e=localStorage.getItem("auth_token");return e&&(a.Authorization=`Bearer ${e}`),fetch(t,{...r,headers:a,credentials:"omit"})}return fetch(t,{...r,headers:a,credentials:"include"})}console.log("[Actinova] API_BASE_URL configured as:",o)},28393:(e,r,t)=>{t.d(r,{AuthProvider:()=>h,h:()=>p});var a=t(95155),s=t(12115),o=t(73321),n=t(37206),i=t(5669);let c=window.Capacitor||"capacitor:"===window.location.protocol||window.origin?.startsWith("capacitor://")||window.origin?.startsWith("http://localhost")||window.origin?.startsWith("https://localhost"),l=(0,n.default)(()=>t.e(7408).then(t.bind(t,27408)),{loadableGenerated:{webpack:()=>[27408]},ssr:!1}),u=(0,n.default)(()=>Promise.all([t.e(6609),t.e(2209)]).then(t.bind(t,2209)),{loadableGenerated:{webpack:()=>[2209]},ssr:!1}),d=(0,s.createContext)();function f(){if("undefined"==typeof document)return null;let e=document.cookie.match(/csrfToken=([^;]+)/);return e?e[1]:null}function h({children:e}){let[r,t]=(0,s.useState)(null),[n,h]=(0,s.useState)(!0),[p,m]=(0,s.useState)(null),[g,y]=(0,s.useState)(!1),[w,v]=(0,s.useState)(120),k=(0,o.useRouter)(),T=(0,o.usePathname)(),S=(0,s.useRef)(null),b=(0,s.useRef)(null),E=(0,s.useRef)(null),C=(0,s.useRef)(Date.now()),P=(0,s.useRef)(null);(0,s.useEffect)(()=>{},[]);let j=(0,s.useCallback)(async()=>(P.current||(P.current=(async()=>{try{if(!(await (0,i.Ud)("/api/refresh",{method:"POST"})).ok)return!1;try{let e=await (0,i.Ud)("/api/me");if(e.ok){let r=await e.json();t(r.user)}}catch(e){console.error("Failed to re-fetch profile after refresh:",e)}return!0}catch(e){return console.error("Token refresh failed:",e),!1}finally{P.current=null}})()),P.current),[]),O=(0,s.useCallback)(async()=>{try{m(null),console.log(`[Actinova] Fetching user from: ${(0,i.e9)("/api/me")}`);let e=await (0,i.Ud)("/api/me");console.log(`[Actinova] /api/me status: ${e.status}`);let r=null;if(e.ok){let a=await e.text();try{return r=JSON.parse(a),t(r.user),h(!1),r.user}catch(e){throw console.error(`[Actinova] Failed to parse /api/me JSON. Response text: ${a.substring(0,100)}...`),Error("Invalid server response format")}}if(401===e.status&&await j()){let e=await (0,i.Ud)("/api/me");if(e.ok)return r=await e.json(),t(r.user),h(!1),r.user}return t(null),null}catch(e){console.error("Failed to fetch user:",e),m(e.message)}finally{h(!1)}},[j]);(0,s.useEffect)(()=>{O()},[O]),(0,s.useEffect)(()=>{if(!r)return;let e=async()=>{"visible"===document.visibilityState&&await j()};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}},[r,j]),(0,s.useEffect)(()=>{!n&&r&&T.startsWith("/auth")&&"/auth/verify-email"!==T&&(!1===r.onboardingCompleted?k.replace("/onboarding"):k.replace("/dashboard"))},[r,n,T,k]);let A=(0,s.useCallback)(()=>{C.current=Date.now(),S.current&&clearTimeout(S.current),b.current&&clearTimeout(b.current),E.current&&clearInterval(E.current),y(!1),v(120),r&&(b.current=setTimeout(()=>{y(!0),v(120),E.current=setInterval(()=>{v(e=>e<=1?(I(),0):e-1)},1e3)},78e4),S.current=setTimeout(()=>{I()},9e5))},[r]),I=(0,s.useCallback)(async()=>{S.current&&clearTimeout(S.current),b.current&&clearTimeout(b.current),E.current&&clearInterval(E.current);try{await fetch((0,i.e9)("/api/logout"),{method:"POST",credentials:"include",headers:{"X-CSRF-Token":f()}})}catch(e){console.error("Logout failed:",e)}t(null),y(!1),k.push("/?loggedOut=inactivity")},[k]),L=(0,s.useCallback)(()=>{A()},[A]);(0,s.useEffect)(()=>{if(!r)return;let e=["mousedown","mousemove","keypress","scroll","touchstart","click"],t=()=>{A()};return e.forEach(e=>{document.addEventListener(e,t,!0)}),A(),()=>{e.forEach(e=>{document.removeEventListener(e,t,!0)}),S.current&&clearTimeout(S.current),b.current&&clearTimeout(b.current),E.current&&clearInterval(E.current)}},[r,A]),(0,s.useEffect)(()=>{r||(S.current&&clearTimeout(S.current),b.current&&clearTimeout(b.current),E.current&&clearInterval(E.current),y(!1))},[r]);let R=async e=>{try{m(null),h(!0);let r=await fetch((0,i.e9)("/api/login"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:c?"omit":"include",body:JSON.stringify(e)}),t=await r.json();if(!r.ok){if(console.error("[Actinova] Login failed status:",r.status,"data:",t),t.requiresVerification)return{success:!1,error:t.error||"Please verify your email first",requiresVerification:!0,email:t.email};throw Error(t.error||"Login failed")}console.log("[Actinova] Login successful, fetching user profile..."),c&&t.token&&(localStorage.setItem("auth_token",t.token),console.log("[Actinova] Token stored in localStorage for Capacitor"));let a=await O();return{success:!0,user:a}}catch(e){return console.error("[Actinova] Login exception:",e),m(e.message),{success:!1,error:e.message}}finally{h(!1)}},U=async e=>{try{m(null),h(!0);let r=await fetch((0,i.e9)("/api/signup"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)}),t=await r.json();if(!r.ok)throw Error(t.error||"Signup failed");return{success:!0,message:t.message,requiresVerification:t.requiresVerification}}catch(e){return m(e.message),{success:!1,error:e.message}}finally{h(!1)}},_=async()=>{try{m(null),await (0,i.Ud)("/api/logout",{method:"POST",headers:{"X-CSRF-Token":f()}}),c&&localStorage.removeItem("auth_token")}catch(e){console.error("Logout failed:",e)}finally{t(null),m(null),k.push("/")}},x=async e=>{try{m(null);let r=await fetch((0,i.e9)("/api/forgot-password"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})}),t=await r.json();if(!r.ok)throw Error(t.error||"Failed to send reset email");return{success:!0,message:t.message}}catch(e){return m(e.message),{success:!1,error:e.message}}},F=async(e,r,t)=>{try{m(null);let a=await fetch((0,i.e9)("/api/reset-password"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e,password:r,confirmPassword:t})}),s=await a.json();if(!a.ok)throw Error(s.error||"Failed to reset password");return{success:!0,message:s.message}}catch(e){return m(e.message),{success:!1,error:e.message}}},N=async e=>{try{m(null);let r=await fetch((0,i.e9)("/api/verify-email"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})}),t=await r.json();if(!r.ok)throw Error(t.error||"Failed to verify email");return{success:!0,message:t.message}}catch(e){return m(e.message),{success:!1,error:e.message}}};return(0,a.jsx)(d.Provider,{value:{user:r,loading:n,error:p,showInactivityModal:g,timeRemaining:w,login:R,signup:U,logout:_,forgotPassword:x,resetPassword:F,verifyEmail:N,refreshToken:j,setUserData:e=>{t(e),h(!1),m(null)},fetchUser:O,clearError:()=>m(null),extendSession:L,handleInactivityLogout:I},children:(0,a.jsxs)(a.Fragment,{children:[e,(0,a.jsx)(u,{}),(0,a.jsx)(l,{})]})})}let p=()=>{let e=(0,s.useContext)(d);return e||{user:null,loading:!1,error:null,showInactivityModal:!1,timeRemaining:120,login:async()=>({success:!1}),signup:async()=>({success:!1}),logout:async()=>{},forgotPassword:async()=>({success:!1}),resetPassword:async()=>({success:!1}),verifyEmail:async()=>({success:!1}),refreshToken:async()=>!1,setUserData:()=>{},fetchUser:async()=>null,clearError:()=>{},extendSession:()=>{},handleInactivityLogout:()=>{}}}}}]);