"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8393],{5669:(e,t,r)=>{r.d(t,{e:()=>o});var a=r(41463);let n=window.origin?.startsWith("capacitor://")||window.origin?.startsWith("http://localhost")||window.origin?.startsWith("https://localhost")||"capacitor:"===window.location.protocol||!!window.Capacitor;console.log("[Actinova] Environment:",{origin:window.origin,isCapacitor:n,protocol:window.location.protocol});let s=a.env.NEXT_PUBLIC_API_URL||"https://actinovatutorapp.vercel.app";function o(e){if(!e)return s;if(e.startsWith("http://")||e.startsWith("https://"))return e;let t=e.startsWith("/")?e:`/${e}`;return n?`${s}${t}`:t}console.log("[Actinova] API_BASE_URL configured as:",s)},28393:(e,t,r)=>{r.d(t,{AuthProvider:()=>f,h:()=>p});var a=r(95155),n=r(12115),s=r(73321),o=r(37206),i=r(5669);let c=window.Capacitor||"capacitor:"===window.location.protocol||window.origin?.startsWith("capacitor://")||window.origin?.startsWith("http://localhost")||window.origin?.startsWith("https://localhost"),l=(0,o.default)(()=>r.e(7408).then(r.bind(r,27408)),{loadableGenerated:{webpack:()=>[27408]},ssr:!1}),u=(0,o.default)(()=>Promise.all([r.e(6609),r.e(2209)]).then(r.bind(r,2209)),{loadableGenerated:{webpack:()=>[2209]},ssr:!1}),d=(0,n.createContext)();function h(){if("undefined"==typeof document)return null;let e=document.cookie.match(/csrfToken=([^;]+)/);return e?e[1]:null}function f({children:e}){let[t,r]=(0,n.useState)(null),[o,f]=(0,n.useState)(!0),[p,m]=(0,n.useState)(null),[g,y]=(0,n.useState)(!1),[w,v]=(0,n.useState)(120),T=(0,s.useRouter)(),k=(0,s.usePathname)(),S=(0,n.useRef)(null),E=(0,n.useRef)(null),b=(0,n.useRef)(null),C=(0,n.useRef)(Date.now()),j=(0,n.useRef)(null);(0,n.useEffect)(()=>{},[]);let P=(0,n.useCallback)(async()=>(j.current||(j.current=(async()=>{try{if(!(await fetch((0,i.e)("/api/refresh"),{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}})).ok)return!1;try{let e=await fetch((0,i.e)("/api/me"),{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}});if(e.ok){let t=await e.json();r(t.user)}}catch(e){console.error("Failed to re-fetch profile after refresh:",e)}return!0}catch(e){return console.error("Token refresh failed:",e),!1}finally{j.current=null}})()),j.current),[]),O=(0,n.useCallback)(async()=>{try{m(null),console.log(`[Actinova] Fetching user from: ${(0,i.e)("/api/me")}`);let e={"Content-Type":"application/json"};if(c){let t=localStorage.getItem("auth_token");t&&(e.Authorization=`Bearer ${t}`)}let t=await fetch((0,i.e)("/api/me"),{credentials:c?"omit":"include",headers:e});console.log(`[Actinova] /api/me status: ${t.status}`);let a=null;if(t.ok){let e=await t.text();try{return a=JSON.parse(e),r(a.user),f(!1),a.user}catch(t){throw console.error(`[Actinova] Failed to parse /api/me JSON. Response text: ${e.substring(0,100)}...`),Error("Invalid server response format")}}if(401===t.status&&await P()){let e=await fetch((0,i.e)("/api/me"),{credentials:"include",headers:{"Content-Type":"application/json"}});if(e.ok)return a=await e.json(),r(a.user),f(!1),a.user}return r(null),null}catch(e){console.error("Failed to fetch user:",e),m(e.message)}finally{f(!1)}},[P]);(0,n.useEffect)(()=>{O()},[O]),(0,n.useEffect)(()=>{if(!t)return;let e=async()=>{"visible"===document.visibilityState&&await P()};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}},[t,P]),(0,n.useEffect)(()=>{!o&&t&&k.startsWith("/auth")&&"/auth/verify-email"!==k&&(!1===t.onboardingCompleted?T.replace("/onboarding"):T.replace("/dashboard"))},[t,o,k,T]);let A=(0,n.useCallback)(()=>{C.current=Date.now(),S.current&&clearTimeout(S.current),E.current&&clearTimeout(E.current),b.current&&clearInterval(b.current),y(!1),v(120),t&&(E.current=setTimeout(()=>{y(!0),v(120),b.current=setInterval(()=>{v(e=>e<=1?(L(),0):e-1)},1e3)},78e4),S.current=setTimeout(()=>{L()},9e5))},[t]),L=(0,n.useCallback)(async()=>{S.current&&clearTimeout(S.current),E.current&&clearTimeout(E.current),b.current&&clearInterval(b.current);try{await fetch((0,i.e)("/api/logout"),{method:"POST",credentials:"include",headers:{"X-CSRF-Token":h()}})}catch(e){console.error("Logout failed:",e)}r(null),y(!1),T.push("/?loggedOut=inactivity")},[T]),I=(0,n.useCallback)(()=>{A()},[A]);(0,n.useEffect)(()=>{if(!t)return;let e=["mousedown","mousemove","keypress","scroll","touchstart","click"],r=()=>{A()};return e.forEach(e=>{document.addEventListener(e,r,!0)}),A(),()=>{e.forEach(e=>{document.removeEventListener(e,r,!0)}),S.current&&clearTimeout(S.current),E.current&&clearTimeout(E.current),b.current&&clearInterval(b.current)}},[t,A]),(0,n.useEffect)(()=>{t||(S.current&&clearTimeout(S.current),E.current&&clearTimeout(E.current),b.current&&clearInterval(b.current),y(!1))},[t]);let R=async e=>{try{m(null),f(!0);let t=await fetch((0,i.e)("/api/login"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:c?"omit":"include",body:JSON.stringify(e)}),r=await t.json();if(!t.ok){if(console.error("[Actinova] Login failed status:",t.status,"data:",r),r.requiresVerification)return{success:!1,error:r.error||"Please verify your email first",requiresVerification:!0,email:r.email};throw Error(r.error||"Login failed")}console.log("[Actinova] Login successful, fetching user profile..."),c&&r.token&&(localStorage.setItem("auth_token",r.token),console.log("[Actinova] Token stored in localStorage for Capacitor"));let a=await O();return{success:!0,user:a}}catch(e){return console.error("[Actinova] Login exception:",e),m(e.message),{success:!1,error:e.message}}finally{f(!1)}},_=async e=>{try{m(null),f(!0);let t=await fetch((0,i.e)("/api/signup"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(e)}),r=await t.json();if(!t.ok)throw Error(r.error||"Signup failed");return{success:!0,message:r.message,requiresVerification:r.requiresVerification}}catch(e){return m(e.message),{success:!1,error:e.message}}finally{f(!1)}},x=async()=>{try{m(null),await fetch((0,i.e)("/api/logout"),{method:"POST",credentials:"include",headers:{"X-CSRF-Token":h()}})}catch(e){console.error("Logout failed:",e)}finally{r(null),m(null),T.push("/")}},F=async e=>{try{m(null);let t=await fetch((0,i.e)("/api/forgot-password"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})}),r=await t.json();if(!t.ok)throw Error(r.error||"Failed to send reset email");return{success:!0,message:r.message}}catch(e){return m(e.message),{success:!1,error:e.message}}},N=async(e,t,r)=>{try{m(null);let a=await fetch((0,i.e)("/api/reset-password"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e,password:t,confirmPassword:r})}),n=await a.json();if(!a.ok)throw Error(n.error||"Failed to reset password");return{success:!0,message:n.message}}catch(e){return m(e.message),{success:!1,error:e.message}}},W=async e=>{try{m(null);let t=await fetch((0,i.e)("/api/verify-email"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})}),r=await t.json();if(!t.ok)throw Error(r.error||"Failed to verify email");return{success:!0,message:r.message}}catch(e){return m(e.message),{success:!1,error:e.message}}};return(0,a.jsx)(d.Provider,{value:{user:t,loading:o,error:p,showInactivityModal:g,timeRemaining:w,login:R,signup:_,logout:x,forgotPassword:F,resetPassword:N,verifyEmail:W,refreshToken:P,setUserData:e=>{r(e),f(!1),m(null)},fetchUser:O,clearError:()=>m(null),extendSession:I,handleInactivityLogout:L},children:(0,a.jsxs)(a.Fragment,{children:[e,(0,a.jsx)(u,{}),(0,a.jsx)(l,{})]})})}let p=()=>{let e=(0,n.useContext)(d);return e||{user:null,loading:!1,error:null,showInactivityModal:!1,timeRemaining:120,login:async()=>({success:!1}),signup:async()=>({success:!1}),logout:async()=>{},forgotPassword:async()=>({success:!1}),resetPassword:async()=>({success:!1}),verifyEmail:async()=>({success:!1}),refreshToken:async()=>!1,setUserData:()=>{},fetchUser:async()=>null,clearError:()=>{},extendSession:()=>{},handleInactivityLogout:()=>{}}}}}]);