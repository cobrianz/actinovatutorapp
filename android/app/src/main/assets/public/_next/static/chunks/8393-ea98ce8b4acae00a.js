"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8393],{5669:(e,r,t)=>{t.d(r,{Ud:()=>i,e9:()=>s});var o=t(41463);let a=!!window.Capacitor||"capacitor:"===window.location.protocol||"localhost"===window.location.hostname&&"3000"!==window.location.port&&"3001"!==window.location.port;console.log("[Actinova] Environment:",{origin:window.origin,isCapacitor:a,protocol:window.location.protocol,host:window.location.host});let n=o.env.NEXT_PUBLIC_API_URL||"https://actinovatutorapp.vercel.app";function s(e){if(!e)return n;if(e.startsWith("http://")||e.startsWith("https://"))return e;let r=e.startsWith("/")?e:`/${e}`;return a?`${n}${r}`:r}async function i(e,r={}){let t=s(e),o={"Content-Type":"application/json",...r.headers};if(a){let e=localStorage.getItem("auth_token");return e&&(o.Authorization=`Bearer ${e}`),fetch(t,{...r,headers:o,credentials:"omit"})}return fetch(t,{...r,headers:o,credentials:"include"})}console.log("[Actinova] API_BASE_URL configured as:",n)},28393:(e,r,t)=>{t.d(r,{AuthProvider:()=>h,h:()=>m});var o=t(95155),a=t(12115),n=t(73321),s=t(37206),i=t(5669);let c=!!window.Capacitor||"capacitor:"===window.location.protocol||"localhost"===window.location.hostname&&"3000"!==window.location.port&&"3001"!==window.location.port,l=(0,s.default)(()=>t.e(7408).then(t.bind(t,27408)),{loadableGenerated:{webpack:()=>[27408]},ssr:!1}),u=(0,s.default)(()=>Promise.all([t.e(6609),t.e(2209)]).then(t.bind(t,2209)),{loadableGenerated:{webpack:()=>[2209]},ssr:!1}),d=(0,a.createContext)();function f(){if("undefined"==typeof document)return null;let e=document.cookie.match(/csrfToken=([^;]+)/);return e?e[1]:null}function h({children:e}){let[r,t]=(0,a.useState)(null),[s,h]=(0,a.useState)(!0),[m,g]=(0,a.useState)(null),[w,p]=(0,a.useState)(!1),[y,v]=(0,a.useState)(120),k=(0,n.useRouter)(),S=(0,n.usePathname)(),T=(0,a.useRef)(null),b=(0,a.useRef)(null),E=(0,a.useRef)(null),C=(0,a.useRef)(Date.now()),P=(0,a.useRef)(null);(0,a.useEffect)(()=>{},[]);let U=(0,a.useCallback)(async()=>(P.current||(P.current=(async()=>{try{if(!(await (0,i.Ud)("/api/refresh",{method:"POST"})).ok)return!1;try{let e=await (0,i.Ud)("/api/me");if(e.ok){let r=await e.json();t(r.user)}}catch(e){console.error("Failed to re-fetch profile after refresh:",e)}return!0}catch(e){return console.error("Token refresh failed:",e),!1}finally{P.current=null}})()),P.current),[]),O=(0,a.useCallback)(async()=>{try{g(null),console.log(`[Actinova] Fetching user from: ${(0,i.e9)("/api/me")}`);let e=await (0,i.Ud)("/api/me");console.log(`[Actinova] /api/me status: ${e.status}`);let r=null;if(e.ok){let o=await e.text();try{return r=JSON.parse(o),t(r.user),h(!1),r.user}catch(e){throw console.error(`[Actinova] Failed to parse /api/me JSON. Response text: ${o.substring(0,100)}...`),Error("Invalid server response format")}}if(401===e.status&&await U()){let e=await (0,i.Ud)("/api/me");if(e.ok)return r=await e.json(),t(r.user),h(!1),r.user}return t(null),null}catch(e){console.error("Failed to fetch user:",e),g(e.message)}finally{h(!1)}},[U]);(0,a.useEffect)(()=>{O()},[O]),(0,a.useEffect)(()=>{if(!r)return;let e=async()=>{"visible"===document.visibilityState&&await U()};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}},[r,U]),(0,a.useEffect)(()=>{!s&&r&&S.startsWith("/auth")&&"/auth/verify-email"!==S&&(!1===r.onboardingCompleted?k.replace("/onboarding"):k.replace("/dashboard"))},[r,s,S,k]);let A=(0,a.useCallback)(()=>{C.current=Date.now(),T.current&&clearTimeout(T.current),b.current&&clearTimeout(b.current),E.current&&clearInterval(E.current),p(!1),v(120),r&&(b.current=setTimeout(()=>{p(!0),v(120),E.current=setInterval(()=>{v(e=>e<=1?(I(),0):e-1)},1e3)},78e4),T.current=setTimeout(()=>{I()},9e5))},[r]),I=(0,a.useCallback)(async()=>{T.current&&clearTimeout(T.current),b.current&&clearTimeout(b.current),E.current&&clearInterval(E.current);try{await (0,i.Ud)("/api/logout",{method:"POST",headers:{"X-CSRF-Token":f()}})}catch(e){console.error("Logout failed:",e)}t(null),p(!1),k.push("/?loggedOut=inactivity")},[k]),L=(0,a.useCallback)(()=>{A()},[A]);(0,a.useEffect)(()=>{if(!r)return;let e=["mousedown","mousemove","keypress","scroll","touchstart","click"],t=()=>{A()};return e.forEach(e=>{document.addEventListener(e,t,!0)}),A(),()=>{e.forEach(e=>{document.removeEventListener(e,t,!0)}),T.current&&clearTimeout(T.current),b.current&&clearTimeout(b.current),E.current&&clearInterval(E.current)}},[r,A]),(0,a.useEffect)(()=>{r||(T.current&&clearTimeout(T.current),b.current&&clearTimeout(b.current),E.current&&clearInterval(E.current),p(!1))},[r]);let j=async e=>{try{g(null),h(!0);let r=await fetch((0,i.e9)("/api/login"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:c?"omit":"include",body:JSON.stringify(e)}),t=await r.json();if(!r.ok){if(console.error("[Actinova] Login failed status:",r.status,"data:",t),t.requiresVerification)return{success:!1,error:t.error||"Please verify your email first",requiresVerification:!0,email:t.email};throw Error(t.error||"Login failed")}console.log("[Actinova] Login successful, fetching user profile..."),c&&t.token&&(localStorage.setItem("auth_token",t.token),console.log("[Actinova] Token stored in localStorage for Capacitor"));let o=await O();return{success:!0,user:o}}catch(e){return console.error("[Actinova] Login exception:",e),g(e.message),{success:!1,error:e.message}}finally{h(!1)}},R=async e=>{try{g(null),h(!0);let r=await (0,i.Ud)("/api/signup",{method:"POST",body:JSON.stringify(e)}),t=await r.json();if(!r.ok)throw Error(t.error||"Signup failed");return{success:!0,message:t.message,requiresVerification:t.requiresVerification}}catch(e){return g(e.message),{success:!1,error:e.message}}finally{h(!1)}},_=async()=>{try{g(null),await (0,i.Ud)("/api/logout",{method:"POST",headers:{"X-CSRF-Token":f()}}),c&&localStorage.removeItem("auth_token")}catch(e){console.error("Logout failed:",e)}finally{t(null),g(null),k.push("/")}},x=async e=>{try{g(null);let r=await (0,i.Ud)("/api/forgot-password",{method:"POST",body:JSON.stringify({email:e})}),t=await r.json();if(!r.ok)throw Error(t.error||"Failed to send reset email");return{success:!0,message:t.message}}catch(e){return g(e.message),{success:!1,error:e.message}}},F=async(e,r,t)=>{try{g(null);let o=await (0,i.Ud)("/api/reset-password",{method:"POST",body:JSON.stringify({token:e,password:r,confirmPassword:t})}),a=await o.json();if(!o.ok)throw Error(a.error||"Failed to reset password");return{success:!0,message:a.message}}catch(e){return g(e.message),{success:!1,error:e.message}}},N=async e=>{try{g(null);let r=await (0,i.Ud)("/api/verify-email",{method:"POST",body:JSON.stringify({token:e})}),t=await r.json();if(!r.ok)throw Error(t.error||"Failed to verify email");return{success:!0,message:t.message}}catch(e){return g(e.message),{success:!1,error:e.message}}};return(0,o.jsx)(d.Provider,{value:{user:r,loading:s,error:m,showInactivityModal:w,timeRemaining:y,login:j,signup:R,logout:_,forgotPassword:x,resetPassword:F,verifyEmail:N,refreshToken:U,setUserData:e=>{t(e),h(!1),g(null)},fetchUser:O,clearError:()=>g(null),extendSession:L,handleInactivityLogout:I},children:(0,o.jsxs)(o.Fragment,{children:[e,(0,o.jsx)(u,{}),(0,o.jsx)(l,{})]})})}let m=()=>{let e=(0,a.useContext)(d);return e||{user:null,loading:!1,error:null,showInactivityModal:!1,timeRemaining:120,login:async()=>({success:!1}),signup:async()=>({success:!1}),logout:async()=>{},forgotPassword:async()=>({success:!1}),resetPassword:async()=>({success:!1}),verifyEmail:async()=>({success:!1}),refreshToken:async()=>!1,setUserData:()=>{},fetchUser:async()=>null,clearError:()=>{},extendSession:()=>{},handleInactivityLogout:()=>{}}}}}]);